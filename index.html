<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balanço de Massa: Dados Completos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-4 font-sans text-gray-800">

    <div class="max-w-7xl mx-auto bg-white p-6 rounded-xl shadow-lg border border-gray-100">
        
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start mb-6 border-b border-gray-100 pb-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Simulação: Dados Completos (12.000kg)</h1>
                <p class="text-gray-500 text-sm mt-1">
                    Calibração: Média ponderada de <strong>todas as leituras</strong> (00:00 até 10:00).
                </p>
            </div>
            
            <div id="status-panel" class="mt-4 md:mt-0 px-4 py-2 rounded-lg bg-gray-100 text-right">
                <div class="text-xs text-gray-500 uppercase font-semibold">Status Final (120h)</div>
                <div id="system-end-status" class="text-xl font-bold text-gray-700">Calculando...</div>
            </div>
        </div>

        <!-- Controles -->
        <div class="mb-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            
            <!-- 1. Abastecimento -->
            <div class="bg-indigo-50 border border-indigo-100 p-4 rounded-lg flex flex-col gap-2">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-bold text-indigo-900">1. Simular Abastecimento</span>
                    <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" id="auto-refill-toggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300"/>
                        <label for="auto-refill-toggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label>
                    </div>
                </div>
                <div class="flex items-center gap-2 opacity-50 transition-opacity" id="slider-container">
                    <input type="range" id="refill-interval" min="12" max="120" value="48" step="4" class="w-full h-1 bg-indigo-200 rounded-lg appearance-none cursor-pointer">
                    <span id="interval-display" class="text-xs font-bold text-indigo-700 bg-white px-2 py-1 rounded border border-indigo-200">48h</span>
                </div>
            </div>

            <!-- 2. Ajuste de Consumo -->
            <div class="bg-orange-50 border border-orange-100 p-4 rounded-lg flex flex-col gap-2">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-sm font-bold text-orange-900">2. Ajuste de Carga</span>
                    <span id="consumption-display" class="text-xs font-bold text-orange-700 bg-white px-2 py-1 rounded border border-orange-200">Normal (100%)</span>
                </div>
                <input type="range" id="consumption-factor" min="0.5" max="2.0" value="1.0" step="0.1" class="w-full h-1 bg-orange-200 rounded-lg appearance-none cursor-pointer accent-orange-600">
                <div class="flex justify-between text-[10px] text-orange-600 font-semibold px-1">
                    <span>-50%</span>
                    <span>Normal</span>
                    <span>+100%</span>
                </div>
            </div>

            <!-- 3. Unidade -->
            <div class="bg-gray-50 border border-gray-200 p-4 rounded-lg flex flex-col justify-center gap-2">
                <span class="text-sm font-bold text-gray-700">3. Visualização</span>
                <div class="flex bg-gray-200 rounded p-1">
                    <button id="btn-unit-pct" class="flex-1 py-1 px-3 rounded text-sm font-bold shadow bg-white text-indigo-600 transition-all">
                        % Nível
                    </button>
                    <button id="btn-unit-kg" class="flex-1 py-1 px-3 rounded text-sm font-bold text-gray-500 hover:bg-gray-100 transition-all">
                        kg Massa
                    </button>
                </div>
            </div>
        </div>

        <style>
            .toggle-checkbox:checked { right: 0; border-color: #4f46e5; }
            .toggle-checkbox:checked + .toggle-label { background-color: #4f46e5; }
            .toggle-checkbox { right: 0; transition: all 0.3s; right: 50%; }
            .toggle-label { width: 2.5rem; }
        </style>

        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Gráfico -->
            <div class="w-full lg:w-3/4 h-[500px] relative">
                <canvas id="mainChart"></canvas>
            </div>
            
            <!-- Painel Info -->
            <div class="w-full lg:w-1/4 flex flex-col gap-4">
                
                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm relative overflow-hidden">
                    <div id="badge-factor" class="absolute top-0 right-0 bg-blue-100 text-blue-600 text-[10px] font-bold px-2 py-1 rounded-bl">
                        +15% MARGEM
                    </div>
                    <h3 class="text-gray-500 text-xs font-bold uppercase mb-2">Consumo Instantâneo</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Base (Média):</span>
                            <span id="base-load" class="font-mono font-bold">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Demanda Forno:</span>
                            <span id="oven-load" class="font-mono font-bold text-orange-600">--</span>
                        </div>
                        <div class="flex justify-between border-t pt-2">
                            <span class="text-sm font-bold text-gray-800">Total Aplicado:</span>
                            <span id="total-load" class="font-mono font-bold text-lg text-indigo-700">--</span>
                        </div>
                    </div>
                </div>

                <div class="bg-orange-50 p-4 rounded-lg border border-orange-100">
                    <h3 class="text-orange-900 font-bold mb-2 text-sm">Status Forno</h3>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-orange-700">Fase (Simulada):</span>
                        <span id="phase-name" class="text-xs font-bold text-orange-900 text-right">--</span>
                    </div>
                    <div class="flex justify-between items-center mt-1">
                        <span class="text-xs text-orange-700">Temp:</span>
                        <span id="oven-temp" class="text-2xl font-bold text-orange-600">--°C</span>
                    </div>
                </div>

                <div class="bg-gray-50 p-3 rounded text-xs text-gray-500 space-y-1">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-blue-800"></div>
                        <span>Leituras (Marcadores)</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-0.5 bg-blue-600"></div>
                        <span>Histórico Linear</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-0.5 bg-indigo-500 border-t border-dashed"></div>
                        <span>Projeção (Futuro)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTES ---
        const TANK_CAPACITY_SINGLE = 4000; 
        const TOTAL_CAPACITY = 12000;
        const SAFETY_LIMIT_PERCENT = 10;
        const REFILL_LEVEL_PERCENT = 85;
        const SAFETY_MARGIN_FACTOR = 1.15; // 15% Margem Padrão

        // --- ESTADO ---
        let currentUnit = 'pct';
        let myChart = null;

        // --- TEMPO ---
        const BAKE_START_STR = '2025-11-26T16:00:00';
        const bakeStartMs = new Date(BAKE_START_STR).getTime();
        const SIMULATION_DURATION_HOURS = 125; 
        const simEndMs = bakeStartMs + (SIMULATION_DURATION_HOURS * 3600000);

        // --- MODELO ---
        function getOvenConsumption(temp) {
            if (temp < 120) return 15;
            if (temp < 245) return 27;
            if (temp < 360) return 40;
            if (temp < 540) return 60;
            return 80;
        }

        const curvePhases = [
            { name: "Rampa 120°C", duration: 6.33, endTemp: 120, type: 'ramp' },
            { name: "Patamar 120°C (24h)", duration: 24, endTemp: 120, type: 'hold' },
            { name: "Rampa 245°C", duration: 8.33, endTemp: 245, type: 'ramp' },
            { name: "Patamar 245°C (20h)", duration: 20, endTemp: 245, type: 'hold' },
            { name: "Rampa 360°C", duration: 7.66, endTemp: 360, type: 'ramp' },
            { name: "Patamar 360°C (20h)", duration: 20, endTemp: 360, type: 'hold' },
            { name: "Rampa 540°C", duration: 7.2, endTemp: 540, type: 'ramp' },
            { name: "Patamar 540°C (20h)", duration: 20, endTemp: 540, type: 'hold' },
            { name: "Rampa 700°C", duration: 6.4, endTemp: 700, type: 'ramp' },
            { name: "Operação 700°C", duration: 10, endTemp: 700, type: 'hold' }
        ];

        function getCurveState(timestamp) {
            let elapsedHours = (timestamp - bakeStartMs) / 3600000;
            if (elapsedHours < 0) return { temp: 25, phase: "Pré-ignição" };
            let temp = 25;
            let timeAcc = 0;
            for (let phase of curvePhases) {
                if (elapsedHours <= timeAcc + phase.duration) {
                    let timeInPhase = elapsedHours - timeAcc;
                    if (phase.type === 'ramp') {
                        let progress = timeInPhase / phase.duration;
                        temp = temp + (phase.endTemp - temp) * progress;
                    } else {
                        temp = phase.endTemp;
                    }
                    return { temp: temp, phase: phase.name };
                }
                temp = phase.endTemp;
                timeAcc += phase.duration;
            }
            return { temp: 700, phase: "Operação" };
        }

        // --- DADOS REAIS ---
        const rawDataIndividual = [
            { time: '2025-11-26T19:00:00', tq1: 33, tq2: 30, tq3: 40 }, 
            { time: '2025-11-26T22:00:00', tq1: 32, tq2: 29, tq3: 38 }, 
            { time: '2025-11-27T00:00:00', tq1: 85, tq2: 85, tq3: 85 }, 
            { time: '2025-11-27T05:00:00', tq1: 61, tq2: 75, tq3: 83 },
            { time: '2025-11-27T10:00:00', tq1: 61, tq2: 69, tq3: 82 } // Último ponto incluído
        ];

        const realHistory = rawDataIndividual.map(point => {
            let mass = ((point.tq1 + point.tq2 + point.tq3) / 300) * TOTAL_CAPACITY;
            let pct = (mass / TOTAL_CAPACITY) * 100;
            return { time: point.time, ts: new Date(point.time).getTime(), pct: pct, mass: mass };
        });

        // Pontos de Calibração
        const pStartRefill = realHistory.find(p => p.time === '2025-11-27T00:00:00');
        // USANDO O ÚLTIMO PONTO DISPONÍVEL (10:00) para calibração completa
        const pEndRefill = realHistory[realHistory.length - 1]; 
        const pLastReal = pEndRefill; 

        // CALIBRAÇÃO (Usando 00h-10h completo)
        let calHours = (pEndRefill.ts - pStartRefill.ts) / 3600000;
        let calMassConsumed = pStartRefill.mass - pEndRefill.mass;
        let calRate = calMassConsumed / calHours; // Média de 10 horas
        
        const OVEN_INITIAL_KG_H = 15; 
        const BASE_LOAD_KG_H = Math.max(0, calRate - OVEN_INITIAL_KG_H);

        // --- UI HANDLERS ---
        const toggleEl = document.getElementById('auto-refill-toggle');
        const sliderInterval = document.getElementById('refill-interval');
        const sliderConsumption = document.getElementById('consumption-factor');
        const btnPct = document.getElementById('btn-unit-pct');
        const btnKg = document.getElementById('btn-unit-kg');

        toggleEl.addEventListener('change', runSimulation);
        sliderInterval.addEventListener('input', (e) => {
            document.getElementById('interval-display').innerText = e.target.value + "h";
            runSimulation();
        });
        
        sliderConsumption.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            const pct = Math.round((val - 1) * 100);
            const signal = pct > 0 ? "+" : "";
            const text = pct === 0 ? "Normal (100%)" : `${signal}${pct}% de Carga`;
            
            const display = document.getElementById('consumption-display');
            if(pct > 0) display.className = "text-xs font-bold text-red-700 bg-red-50 px-2 py-1 rounded border border-red-200";
            else if (pct < 0) display.className = "text-xs font-bold text-green-700 bg-green-50 px-2 py-1 rounded border border-green-200";
            else display.className = "text-xs font-bold text-orange-700 bg-white px-2 py-1 rounded border border-orange-200";
            
            display.innerText = text;
            runSimulation();
        });

        const setUnit = (unit) => {
            currentUnit = unit;
            if (unit === 'pct') {
                btnPct.className = "flex-1 py-1 px-3 rounded text-sm font-bold shadow bg-white text-indigo-600 transition-all";
                btnKg.className = "flex-1 py-1 px-3 rounded text-sm font-bold text-gray-500 hover:bg-gray-100 transition-all";
            } else {
                btnKg.className = "flex-1 py-1 px-3 rounded text-sm font-bold shadow bg-white text-indigo-600 transition-all";
                btnPct.className = "flex-1 py-1 px-3 rounded text-sm font-bold text-gray-500 hover:bg-gray-100 transition-all";
            }
            runSimulation();
        }
        btnPct.onclick = () => setUnit('pct');
        btnKg.onclick = () => setUnit('kg');

        // --- SIMULAÇÃO ---
        function runSimulation() {
            const isAutoRefill = toggleEl.checked;
            const refillIntervalMs = parseInt(sliderInterval.value) * 3600000;
            const consumptionFactor = parseFloat(sliderConsumption.value);
            const isKg = currentUnit === 'kg';

            const series = { real: [], projected: [], temp: [], markers: [] };
            const stepMs = 10 * 60000;

            // 1. Temp Background
            for(let t = bakeStartMs; t <= simEndMs; t += stepMs) {
                series.temp.push({ x: t, y: getCurveState(t).temp });
            }

            // 2. Dados Reais (Dense Interpolação para hover)
            for(let i=0; i<realHistory.length-1; i++) {
                let start = realHistory[i];
                let end = realHistory[i+1];
                let diff = end.ts - start.ts;
                let steps = Math.floor(diff / stepMs);
                for(let k=0; k<=steps; k++) { 
                    let t = start.ts + (k*stepMs);
                    let progress = k/steps;
                    let pctVal = start.pct + (end.pct - start.pct) * progress;
                    let massVal = start.mass + (end.mass - start.mass) * progress;
                    if(t >= bakeStartMs) {
                        series.real.push({ x: t, y: isKg ? massVal : pctVal });
                    }
                }
            }

            // 3. Marcadores (Bolinhas)
            realHistory.forEach(pt => {
                if(pt.ts >= bakeStartMs) {
                    series.markers.push({ x: pt.ts, y: isKg ? pt.mass : pt.pct });
                }
            });

            // 4. Projeção
            let simTime = pLastReal.ts;
            let currentMass = pLastReal.mass;
            let lastRefillTime = pStartRefill.ts; 

            series.projected.push({ x: simTime, y: isKg ? currentMass : pLastReal.pct });

            let failureDate = null;

            while(simTime < simEndMs) {
                // Abastecimento
                if(isAutoRefill && (simTime - lastRefillTime) >= refillIntervalMs) {
                    let preVal = isKg ? currentMass : (currentMass/TOTAL_CAPACITY)*100;
                    series.projected.push({ x: simTime, y: preVal });
                    currentMass = (REFILL_LEVEL_PERCENT/100) * TOTAL_CAPACITY;
                    let postVal = isKg ? currentMass : REFILL_LEVEL_PERCENT;
                    series.projected.push({ x: simTime, y: postVal });
                    lastRefillTime = simTime;
                }

                simTime += stepMs;
                
                let state = getCurveState(simTime);
                let ovenLoad = getOvenConsumption(state.temp);
                let totalLoad = (BASE_LOAD_KG_H + ovenLoad) * SAFETY_MARGIN_FACTOR * consumptionFactor;
                
                currentMass -= totalLoad * (10/60); // 10 min step

                if(currentMass <= (SAFETY_LIMIT_PERCENT/100)*TOTAL_CAPACITY) {
                    currentMass = (SAFETY_LIMIT_PERCENT/100)*TOTAL_CAPACITY;
                    if(!failureDate) failureDate = new Date(simTime);
                }

                series.projected.push({ x: simTime, y: isKg ? currentMass : (currentMass/TOTAL_CAPACITY)*100 });

                if(failureDate && !isAutoRefill && simTime > failureDate.getTime() + (12*3600000)) break;
            }

            updateChart(series, pLastReal.ts, isKg);
            updateStatus(failureDate, consumptionFactor, isAutoRefill, simTime);
        }

        function updateStatus(failureDate, factor, isAutoRefill, finalTime) {
            let now = Date.now(); if(now < bakeStartMs) now = bakeStartMs;
            let state = getCurveState(now);
            let oven = getOvenConsumption(state.temp);
            let total = (BASE_LOAD_KG_H + oven) * SAFETY_MARGIN_FACTOR * factor;

            document.getElementById('base-load').innerText = BASE_LOAD_KG_H.toFixed(0) + " kg/h";
            document.getElementById('oven-load').innerText = oven + " kg/h";
            document.getElementById('total-load').innerText = total.toFixed(0) + " kg/h";
            document.getElementById('phase-name').innerText = state.phase;
            document.getElementById('oven-temp').innerText = Math.round(state.temp) + "°C";

            let badge = document.getElementById('badge-factor');
            let pctAdj = Math.round((factor - 1) * 100);
            badge.innerText = (pctAdj > 0 ? "+" : "") + pctAdj + "% MARGEM";
            badge.className = pctAdj > 0 ? "absolute top-0 right-0 bg-red-100 text-red-600 text-[10px] font-bold px-2 py-1 rounded-bl" : "absolute top-0 right-0 bg-green-100 text-green-600 text-[10px] font-bold px-2 py-1 rounded-bl";

            let statusTxt = document.getElementById('system-end-status');
            let statusPn = document.getElementById('status-panel');
            
            if(failureDate) {
                let d = failureDate;
                statusTxt.innerText = `COLAPSO: ${d.getDate()}/${d.getMonth()+1} às ${d.getHours()}:00`;
                statusTxt.className = "text-xl font-bold text-red-700";
                statusPn.className = "mt-4 md:mt-0 px-4 py-2 rounded-lg bg-red-100 border border-red-200 text-right";
            } else {
                statusTxt.innerText = isAutoRefill ? "OPERAÇÃO ESTÁVEL" : "OK > 120h";
                statusTxt.className = "text-xl font-bold text-green-700";
                statusPn.className = "mt-4 md:mt-0 px-4 py-2 rounded-lg bg-green-100 border border-green-200 text-right";
            }
        }

        function updateChart(series, transitionTs, isKg) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if(myChart) myChart.destroy();

            const yMax = isKg ? 12500 : 100;
            const critVal = isKg ? 1200 : 10;

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Temp Forno', data: series.temp,
                            borderColor: 'rgba(239, 68, 68, 0.1)', borderWidth: 0,
                            backgroundColor: 'rgba(239, 68, 68, 0.05)', fill: true, pointRadius: 0, yAxisID: 'yTemp', order: 4
                        },
                        {
                            label: 'Histórico', data: series.real,
                            borderColor: '#2563eb', borderWidth: 3, pointRadius: 0,
                            pointHoverRadius: 4, yAxisID: 'yLevel', tension: 0, order: 2
                        },
                        {
                            label: 'Leituras', data: series.markers,
                            borderColor: '#1e40af', backgroundColor: 'white', borderWidth: 2, pointRadius: 6,
                            showLine: false, yAxisID: 'yLevel', order: 1
                        },
                        {
                            label: 'Projeção', data: series.projected,
                            borderColor: '#4f46e5', borderDash: [5, 5], borderWidth: 2,
                            pointRadius: 0, pointHoverRadius: 4, yAxisID: 'yLevel', tension: 0.1, order: 3
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'nearest', axis: 'x', intersect: false },
                    scales: {
                        x: { type: 'time', min: bakeStartMs, max: simEndMs, time: { unit: 'day', displayFormats: { day: 'dd/MM' } } },
                        yLevel: { type: 'linear', position: 'left', min: 0, max: yMax, title: { display: true, text: isKg ? 'Massa (kg)' : 'Nível (%)' } },
                        yTemp: { type: 'linear', position: 'right', min: 0, max: 800, grid: { drawOnChartArea: false } }
                    },
                    plugins: {
                        annotation: {
                            annotations: {
                                line: { type: 'line', xMin: transitionTs, xMax: transitionTs, borderColor: 'gray', borderWidth: 2, borderDash: [2,2] },
                                crit: { type: 'line', yMin: critVal, yMax: critVal, yScaleID: 'yLevel', borderColor: 'red', borderWidth: 1 }
                            }
                        }
                    }
                }
            });
        }

        runSimulation();
    </script>
</body>
</html>